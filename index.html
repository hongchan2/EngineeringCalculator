<!DOCTYPE html>
<html>
  <head>
    <title>Calculator</title>

    <link type="text/css" rel="stylesheet" href="./popmodal/popModal.css">
    <link rel="stylesheet" href="main.css">
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js' type='text/javascript'></script>
    <script src="./popmodal/popModal.js"></script>
    <script src='math.js' type='text/javascript'></script>
    <script>
    //$(document).ready(function(){
    $(function(){
        var copied; // Copy and Paste
        var susic = []; // History
        var result = []; // History
        var historyCnt = 0; // History
        var temp; // History
        var rightSusic = false; // History
        var help = false; // Help

        var $resultHint = $('<div class="hintHide"> 입력된 수식의 결과를 표시합니다.</div>');

        var parser = math.parser();
        var displayValue = '';

        $('#userInput').text(displayValue);

        $('.key, .dropKey, .operationKey').each(function(index, key){
            $(this).click(function(e){
                var clickedText = $(this).text();

                /* Change character */
                switch(clickedText){
                  case '×':
                    clickedText = '*';
                    break;
                  case '÷':
                    clickedText = '/';
                    break;
                  case 'π':
                    clickedText = 'pi';
                    break;
                  case 'x^2':
                    clickedText = '^2';
                    break;
                }

                /* Evaluate */
                if(clickedText == 'EV')
                {
                  rightSusic = true;
                    temp = displayValue;
                    try
                    {
                      if(displayValue != '')
                      {
                        displayValue = parser.eval(displayValue).toString();
                      }
                      else
                      {
                        displayValue = '0';
                        rightSusic = false;
                      }
                      var tokens = displayValue.split(' ');

                      /* Function */
                      if(tokens[0] == 'function')
                      {
                        displayValue = tokens[0];
                        rightSusic = false;
                      }
                      /* ERROR */
                      else if(tokens[0] == 'error'){
                        rightSusic = false;
                      }

                      /* Push to Susic, Result Array */
                      if(rightSusic){
                        susic.push(temp);
                        result.push(displayValue);
                      }

                      $('#status').text("Result");
                      $('#result').text(displayValue);
                      displayValue = '';
                      temp = '';
                      rightSusic = false;
                    }
                    catch (e)
                    {
                        displayValue = '';
                        if(displayValue != 'function')
                        {
                            $('#result').text(e);
                        }
                    }
                }
                else
                {
                    /* Clear */
                    if(clickedText == 'AC')
                    {
                        displayValue = '';
                        $('#userInput').text(displayValue);
                        $('#result').text('');
                        $('#status').text("Clear");
                    }
                    /* Backspace */
                    else if(clickedText == '←'){
                      displayValue = displayValue.substring(0, displayValue.length - 1);
                      $('#userInput').text(displayValue);
                      $('#status').text("Erase");
                    }
                    /* Input */
                    else
                    {
                        displayValue += clickedText;
                        $('#userInput').text(displayValue);
                        $('#result').text('');
                        $('#status').text("Input");
                    }
                }

                e.preventDefault()
            })
        })

        /* Install Dropdown Event Handler */
        $('.selectBox').click(function(){
          $('#status').text("");
          var $dropDown = $(this);
          var toggle = $dropDown.children().hasClass('show');
          if(toggle == true){
            $dropDown.children().removeClass('show');
            $dropDown.removeClass('selected');
            $dropDown.children().slideUp(400);
          }else{
            $dropDown.children().addClass('show');
            $dropDown.addClass('selected');
            $dropDown.children().slideDown(400);
          }
        });

        /* Install Copy, Paste Event Handler */
        $('.addKey').click(function(e){
          var key = $(this).text();
          if(key == "Copy"){
            var text = $('#userInput').get(0);
            var selection = window.getSelection();
            var range = document.createRange();
            
            /* Copy to Clip Board */
            range.selectNodeContents(text);
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('Copy');

            /* Copy to Local Variable */
            copied = $('#userInput').text();
            $('#status').text("Copy");
          }
          else if(key == "Paste"){
            /* Append Paste */
            displayValue += copied;
            $('#userInput').text(displayValue);
            $('#status').text("Paste");
          }
        });

        /* Install History Event Handler */
        $('#history').click(function(){
            /* Add New Susic And Result */
            for(var i = 0; i < susic.length; i++){
              var content1 = '<tr><td class="susic">' +susic[i] + '</td>';
              var content2 = '<td class="result">' + result[i] + '</td></tr>';

              var $div = $(content1 + content2);
              $('#historyPrint').append($div);
            }

            /* Clear Array */
            susic.splice(0, susic.length);
            result.splice(0, result.length);

            /* Show Popup Screen */
            $('#additional').popModal({
              html : $('#historyContent').html()
            });
        });

        /* Install Help Event Handler */
        $('#help').click(function(){
          /* Original Mode (Hide ToolTip) */
          if(help){
            help = false;
            $(this).removeClass('helpSelected');

            $('.hintModal > div').removeClass('hintModal_container');
            $('.hintModal > div').addClass('hintHide');
            $('#status').text("");
          }
          /* Explain Mode (Show ToolTip) */
          else{
            help = true;
            // add result, status tag

            $(this).addClass('helpSelected');

            $('.hintModal > div').removeClass('hintHide');
            $('.hintModal > div').addClass('hintModal_container');
            $('#status').text("Help");
          }
        });
    });
    </script>
  </head>
  <body>
    <div id="historyContent" style="display:none">
        <div>
          <table id="historyPrint">
            <tr>
              <td class="susic title">수식</td>
              <td class="result title">결과</td>
            </tr>
          </table>
        </div>

        <div class="popModal_footer">
            <button type="button" data-popModalBut="ok">ok</button>
            <button type="button" data-popModalBut="cancel">cancel</button>
        </div>
    </div>

    <div id="calculator">
      <div id="userInput" class="hintModal">
          <div class="hintHide">
              사용자의 입력이 표시됩니다.
          </div>
      </div>
      <div id="status" class="hintModal">
          <div class="hintHide">
              현재 계산기 상태를 표시합니다.<br>
              Input - 사용자 입력<br>
              Reuslt - 수식의 결과 출력<br>
          </div>
      </div>
      <div id="result" class="hintModal">
          <div class="hintHide">
              입력된 수식의 결과를 표시합니다.
          </div>
      </div>
      <table id="operation">
        <tr>
          <td class="operationKey hintModal">cross
              <div class="hintHide">
                  @외적 설명
              </div>
          </td>
          <td class="operationKey hintModal">dot
              <div class="hintHide">
                  @내적 설명
              </div>
          </td>
          <td class="operationKey hintModal">det
              <div class="hintHide">
                  @행렬식 설명
              </div>
          </td>
          <td class="operationKey hintModal">inv
              <div class="hintHide">
                  @행렬식 설명
              </div>
          </td>
        </tr>
        <tr>
          <td class="operationKey hintModal">exp
              <div class="hintHide">
                  @지수함수 설명
              </div>
          </td>
          <td class="operationKey hintModal">sqrt
              <div class="hintHide">
                  표시된 값의 제곱근을 계산합니다.
              </div>
          </td>
          <td class="operationKey hintModal">x^2
              <div class="hintHide">
                  표시된 값을 제곱합니다.
              </div>
          </td>
          <td class="operationKey hintModal">x^y
              <div class="hintHide">
                  표시된 값을 다음에 입력된 값의 거듭제곱으로 올립니다.
              </div>
          </td>
        </tr>
        <tr>
          <td class="operationKey hintModal">n!
              <div class="hintHide">
                  표시된 값의 계승값을 계산합니다.
              </div>
          </td>
          <td class="operationKey hintModal">i
              <div class="hintHide">
                  복소수 'i' 를 입력합니다.
              </div>
          </td>
          <td class="operationKey hintModal">e
              <div class="hintHide">
                  e(2.71828...)을 입력합니다.
              </div>
          </td>
          <td class="operationKey hintModal">π
              <div class="hintHide">
                pi(3.14159...)를 입력합니다.
              </div>
          </td>
        </tr>
      </table>
      <div id="box">
        <table>
          <tr>
            <td class="selectBox">x, y, z
              <div class="dropDown">
                <span class="dropKey">x</span>
                <span class="dropKey">y</span>
                <span class="dropKey">z</span>
              </div>
            </td>
            <td class="selectBox">f(x)
                <div class="dropDown">
                    <span class="dropKey">f(x)</span>
                    <span class="dropKey">g(x)</span>
                </div>
            </td>
          </tr>
          <tr>
            <td class="selectBox">( ) [ ]
                <div class="dropDown">
                    <span class="dropKey">(</span>
                    <span class="dropKey">)</span>
                    <span class="dropKey">[</span>
                    <span class="dropKey">]</span>
                </div>
            </td>
            <td class="selectBox hangul">로그함수
                <div class="dropDown">
                    <span class="dropKey">log</span>
                    <span class="dropKey">ln</span>
                </div>
            </td>
          </tr>
          <tr>
            <td class="selectBox hangul">삼각함수
                <div class="dropDown">
                    <span class="dropKey">sin</span>
                    <span class="dropKey">cos</span>
                    <span class="dropKey">tan</span>
                </div>
            </td>
            <td class="selectBox hangul">비교연산
                <div class="dropDown">
                  <span class="dropKey">==</span>
                  <span class="dropKey">!=</span>
                  <span class="dropKey">></span>
                  <span class="dropKey"><</span>
                  <span class="dropKey">>=</span>
                  <span class="dropKey"><=</span>
                </div>
            </td>
          </tr>
        </table>
      </div>
      <table id="additional">
        <tr>
          <td id="help" class="addKey">Help</td>
          <td id="history" class="addKey">History</td>
          <td class="addKey">Copy</td>
          <td class="addKey">Paste</td>
         </tr>
      </table>
      <div id="number">
        <table>
          <tr>
            <td class="key">7</td>
            <td class="key">8</td>
            <td class="key">9</td>
            <td class="key importantkey">←</td>
            <td class="key importantkey">AC</td>
          </tr>
          <tr>
            <td class="key">4</td>
            <td class="key">5</td>
            <td class="key">6</td>
            <td class="key semimportantkey">×</td>
            <td class="key semimportantkey">÷</td>
          </tr>
          <tr>
            <td class="key">1</td>
            <td class="key">2</td>
            <td class="key">3</td>
            <td class="key semimportantkey">+</td>
            <td class="key semimportantkey">-</td>
          </tr>
          <tr>
            <td class="key smalltr">.</td>
            <td class="key smalltr">,</td>
            <td class="key">0</td>
            <td class="key">%</td>
            <td class="key semimportantkey">=</td>
            <td class="key importantkey">EV</td>
          </tr>
        </table>
      </div>
    </div>
  </body>
</html>
