<!DOCTYPE html>
<html>
  <head>
    <title>Calculator</title>

    <link type="text/css" rel="stylesheet" href="./popmodal/popModal.css">
    <link rel="stylesheet" href="main.css">
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js' type='text/javascript'></script>
    <script src="./popmodal/popModal.js"></script>
    <script src='math.js' type='text/javascript'></script>
    <script>
    //$(document).ready(function(){
    $(function(){
        var copied; // Copy and Paste
        var susic = []; // History
        var result = []; // History
        var historyCnt = 0; // History
        var temp; // History
        var rightSusic = false; // History

        var parser = math.parser();
        var displayValue = '';

        $('#userInput').text(displayValue);

        $('.key, .dropKey, .operationKey').each(function(index, key){
            $(this).click(function(e){
                var clickedText = $(this).text();

                /* Change character */
                switch(clickedText){
                  case '×':
                    clickedText = '*';
                    break;
                  case '÷':
                    clickedText = '/';
                    break;
                  case 'π':
                    clickedText = 'pi';
                    break;
                  case 'x^2':
                    clickedText = '^2';
                    break;
                }

                /* Evaluate */
                if(clickedText == 'EV')
                {
                  rightSusic = true;
                    temp = displayValue;
                    try
                    {
                      if(displayValue != '')
                      {
                        displayValue = parser.eval(displayValue).toString();
                      }
                      else
                      {
                        displayValue = '0';
                        rightSusic = false;
                      }
                      var tokens = displayValue.split(' ');

                      /* Function */
                      if(tokens[0] == 'function')
                      {
                        displayValue = tokens[0];
                        rightSusic = false;
                      }
                      /* ERROR */
                      else if(tokens[0] == 'error'){
                        rightSusic = false;
                      }

                      /* Push to Susic, Result Array */
                      if(rightSusic){
                        susic.push(temp);
                        result.push(displayValue);
                      }

                      $('#status').text("Result");
                      $('#result').text(displayValue);
                      displayValue = '';
                      temp = '';
                      rightSusic = false;
                    }
                    catch (e)
                    {
                        displayValue = '';
                        if(displayValue != 'function')
                        {
                            $('#result').text(e);
                        }
                    }
                }
                else
                {
                    /* Clear */
                    if(clickedText == 'AC')
                    {
                        displayValue = '';
                        $('#userInput').text(displayValue);
                        $('#result').text('');
                        $('#status').text("Clear");
                    }
                    /* Backspace */
                    else if(clickedText == '←'){
                      displayValue = displayValue.substring(0, displayValue.length - 1);
                      $('#userInput').text(displayValue);
                      $('#status').text("Erase");
                    }
                    /* Input */
                    else
                    {
                        displayValue += clickedText;
                        $('#userInput').text(displayValue);
                        $('#result').text('');
                        $('#status').text("Input");
                    }
                }

                e.preventDefault()
            })
        })

        /* Install Dropdown Event Handler */
        $('.selectBox').click(function(){
          $('#status').text("");
          var $dropDown = $(this);
          var toggle = $dropDown.children().hasClass('show');
          if(toggle == true){
            $dropDown.children().removeClass('show');
            $dropDown.removeClass('selected');
            $dropDown.children().slideUp(400);
          }else{
            $dropDown.children().addClass('show');
            $dropDown.addClass('selected');
            $dropDown.children().slideDown(400);
          }
        });

        /* Install Copy, Paste Event Handler */
        $('.addKey').click(function(e){
          var key = $(this).text();
          if(key == "Copy"){
            var text = $('#userInput').get(0);
            var selection = window.getSelection();
            var range = document.createRange();
            
            /* Copy to Clip Board */
            range.selectNodeContents(text);
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('Copy');

            /* Copy to Local Variable */
            copied = $('#userInput').text();
            $('#status').text("Copy");
          }
          else if(key == "Paste"){
            /* Append Paste */
            displayValue += copied;
            $('#userInput').text(displayValue);
            $('#status').text("Paste");
          }
        });

        /* Install History Event Handler */
        $('#history').click(function(){

            /* Add New Susic And Result */
            for(var i = 0; i < susic.length; i++){
              var content1 = '<div><span class="susic">' + susic[i] + '</span>';
              var content2 = '<span class="result">' + result[i] + '</span></div>';

              var $div = $(content1 + content2);
              $('#historyPrint').append($div);
            }

            /* Clear Array */
            susic.splice(0, susic.length);
            result.splice(0, result.length);

            $('#additional').popModal({
              html : $('#historyContent').html()
            });
        });

        /* Install Help Event Handler */
        $('#help').click(function(){
          
        });
    });
    </script>
  </head>
  <body>

    <div id="historyContent" style="display:none">
        <span>수식</span>
        <span>결과</span>
        <p></p>
        <div id="historyPrint">
          <div>
              <span>
                dd
              </span>
              <span>
                ewruls
              </span>
            </div>
        </div>

        <div class="popModal_footer">
            <button type="button" data-popModalBut="ok">ok</button>
            <button type="button" data-popModalBut="cancel">cancel</button>
        </div>
    </div>

    <div id="calculator">
      <div id="userInput"></div>
      <div id="status"></div>
      <div id="result"></div>
      <table id="operation">
        <tr>
          <td class="operationKey">cross</td>
          <td class="operationKey">dot</td>
          <td class="operationKey">det</td>
          <td class="operationKey">inv</td>
        </tr>
        <tr>
          <td class="operationKey">exp</td>
          <td class="operationKey">sqrt</td>
          <td class="operationKey">x^2</td>
          <td class="operationKey">x^y</td>
        </tr>
        <tr>
          <td class="operationKey">n!</td>
          <td class="operationKey">i</td>
          <td class="operationKey">e</td>
          <td class="operationKey">π</td>
        </tr>
      </table>
      <div id="box">
        <table>
          <tr>
            <td class="selectBox">x, y, z
              <div class="dropDown">
                <span class="dropKey">x</span>
                <span class="dropKey">y</span>
                <span class="dropKey">z</span>
              </div>
            </td>
            <td class="selectBox">f(x)
                <div class="dropDown">
                    <span class="dropKey">f(x)</span>
                    <span class="dropKey">g(x)</span>
                </div>
            </td>
          </tr>
          <tr>
            <td class="selectBox">( ) [ ]
                <div class="dropDown">
                    <span class="dropKey">(</span>
                    <span class="dropKey">)</span>
                    <span class="dropKey">[</span>
                    <span class="dropKey">]</span>
                </div>
            </td>
            <td class="selectBox hangul">로그함수
                <div class="dropDown">
                    <span class="dropKey">log</span>
                    <span class="dropKey">ln</span>
                </div>
            </td>
          </tr>
          <tr>
            <td class="selectBox hangul">삼각함수
                <div class="dropDown">
                    <span class="dropKey">sin</span>
                    <span class="dropKey">cos</span>
                    <span class="dropKey">tan</span>
                </div>
            </td>
            <td class="selectBox hangul">비교연산
                <div class="dropDown">
                  <span class="dropKey">==</span>
                  <span class="dropKey">!=</span>
                  <span class="dropKey">></span>
                  <span class="dropKey"><</span>
                  <span class="dropKey">>=</span>
                  <span class="dropKey"><=</span>
                </div>
            </td>
          </tr>
        </table>
      </div>
      <table id="additional">
        <tr>
          <td id="help" class="addKey">Help</td>
          <td id="history" class="addKey">History</td>
          <td class="addKey">Copy</td>
          <td class="addKey">Paste</td>
         </tr>
      </table>
      <div id="number">
        <table>
          <tr>
            <td class="key">7</td>
            <td class="key">8</td>
            <td class="key">9</td>
            <td class="key importantkey">←</td>
            <td class="key importantkey">AC</td>
          </tr>
          <tr>
            <td class="key">4</td>
            <td class="key">5</td>
            <td class="key">6</td>
            <td class="key semimportantkey">×</td>
            <td class="key semimportantkey">÷</td>
          </tr>
          <tr>
            <td class="key">1</td>
            <td class="key">2</td>
            <td class="key">3</td>
            <td class="key semimportantkey">+</td>
            <td class="key semimportantkey">-</td>
          </tr>
          <tr>
            <td class="key smalltr">.</td>
            <td class="key smalltr">,</td>
            <td class="key">0</td>
            <td class="key">%</td>
            <td class="key semimportantkey">=</td>
            <td class="key importantkey">EV</td>
          </tr>
        </table>
      </div>
    </div>
  </body>
</html>
